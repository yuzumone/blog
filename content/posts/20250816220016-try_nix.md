+++
title = "Try nix"
author = ["yuzumone"]
date = 2025-08-16
slug = "try-nix"
tags = ["Nix"]
draft = false
toc = false
image = "https://images.unsplash.com/photo-1542601098-8fc114e148e2?q=80&w=2340&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
+++

{{< figure title="Photo by Aditya Vyas on Unsplash" src="https://images.unsplash.com/photo-1542601098-8fc114e148e2?q=80&w=2340&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" >}}

Nix に入門してみました． <br/>
homebrew 代替となる home-manager や nix-darwin などがありますが，今回は開発環境整備で利用してみることにします． <br/>
devcontainer 的な感じですね． <br/>


## インストール {#インストール}

公式のインストーラーではなく，Determinate Systems の nix-installer を利用します． <br/>
公式よりも Determinate Systems の方が Flakes がデフォルト有効化されているなどのメリットがあるようです． <br/>

```bash
curl -fsSL https://install.determinate.systems/nix | sh -s -- install
```


## nix develop {#nix-develop}

このコマンドを使うと，プロジェクトに定義された依存関係（コンパイラ、ライブラリ、ツールなど）を含む開発用のシェル環境が起動します． <br/>
具体的には flake.nix ファイルの devShell に定義された環境が起動する，というこのようです． <br/>
flake.nix は公式 Org に templates がまとまっているので，ここから始めるのがよさそう． <br/>

{{< embed url="https://github.com/NixOS/templates" >}}

```bash
$ nix develop
bash-5.2$ which python
/nix/store/xzjghvsg4fhr2vv6h4scihsdrgk4i76w-python3-3.12.9/bin/python
```


## nix-direnv {#nix-direnv}

nix develop では shell が bash で起動します． <br/>
普段は fish shell を利用しているので，fish で起動して欲しいところです． <br/>
nix-direnv を利用すると direnv が環境変数を自動でロードするように，devShell がロードされるようになります． <br/>
もちろん shell も普段利用しているものが利用できます． <br/>

{{< embed title="nix-direnv" url="https://github.com/nix-community/nix-direnv" >}}

home-manager は利用していないため，以下のコマンドでインストールしました． <br/>

```bash
nix profile install nixpkgs#nix-direnv
```

また， `$HOME/.config/direnv/direnvrc` に以下を記載します． <br/>

```bash
source $HOME/.nix-profile/share/nix-direnv/direnvrc
```

あとは `use flake` でそのディレクトリにある flake.nix がロードされるようになります． <br/>

```bash
echo "use flake" >> .envrc && direnv allow
```

他のディレクトリのものを参照することもできます． <br/>

```bash
use flake ~/flake-templates/python
```


## まとめ {#まとめ}

nix develop で nix に入門してみました． <br/>
メリットは以下かなと思います． <br/>

-   オーバーヘッドがない <br/>
    -   devcontainer と異なり，shell が起動するだけのためオーバーヘッドがない <br/>
    -   特に Apple silicon を利用していると，x86 なコンテナはオーバーヘッドがデカい <br/>
-   既存のツールが利用できる <br/>
    -   devcontainer の場合コンテナに入っていないと利用できない (あたりまえ体操) <br/>
        -   fish, eza, bat, ripgrep などなど... <br/>
-   ロックファイル <br/>
    -   flake.lock で環境をロックできる <br/>
        -   開発環境の再現性が高い <br/>
    -   といってもチームで nix を利用するのはハードルが高そうだが…… <br/>

